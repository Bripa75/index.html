<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tutoring Dashboard</title>

<style>

/* ========== GLOBAL STYLES ========== */

body {
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background: #0d0d0d;
  color: white;
}

header {
  background: #111;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #222;
}

header h1 {
  margin: 0;
  font-size: 26px;
  font-weight: bold;
}

button.edit-toggle {
  padding: 10px 18px;
  background: #0077ff;
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  font-size: 14px;
}

/* DASHBOARD GRID */

.dashboard-container {
  padding: 20px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
}

.card {
  background: #161616;
  border-radius: 8px;
  padding: 20px;
  border: 1px solid #222;
}

.card h2 {
  margin-top: 0;
  font-size: 20px;
}

/* TABLE STYLES */

.table-wrapper {
  margin-top: 15px;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  color: white;
}

table th, table td {
  padding: 10px;
  border-bottom: 1px solid #333;
  text-align: left;
}

/* CHART AREA */
#revenueChart, #studentsChart {
  width: 100%;
  height: 240px;
}

/* ADMIN PANEL */

#adminPanel {
  position: fixed;
  right: -420px;
  top: 0;
  width: 420px;
  height: 100%;
  background: #111;
  border-left: 1px solid #333;
  padding: 20px;
  overflow-y: auto;
  transition: right 0.35s ease;
  z-index: 99;
}

#adminPanel.open {
  right: 0;
}

.admin-section {
  margin-bottom: 30px;
}

.admin-section h3 {
  margin-top: 20px;
  font-size: 18px;
}

input, select {
  width: 100%;
  padding: 8px;
  margin-top: 6px;
  margin-bottom: 12px;
  background: #1a1a1a;
  border: 1px solid #333;
  color: white;
  border-radius: 5px;
}

button.save-btn {
  background: #28a745;
  padding: 10px;
  border: none;
  color: white;
  width: 100%;
  border-radius: 6px;
  cursor: pointer;
}

button.delete-btn {
  background: #cc0000;
  padding: 10px;
  border: none;
  color: white;
  width: 100%;
  border-radius: 6px;
  cursor: pointer;
}

</style>
</head>

<body>

<header>
  <h1>Brian's Tutoring Dashboard</h1>
  <button class="edit-toggle" onclick="toggleAdminPanel()">ðŸ”§ Edit Dashboard</button>
</header>

<div class="dashboard-container">

  <!-- STUDENTS CARD -->
  <div class="card">
    <h2>Students</h2>
    <div class="table-wrapper">
      <table id="studentsTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Grade</th>
            <th>Rate</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- WEEKLY SCHEDULE -->
  <div class="card">
    <h2>Weekly Schedule</h2>
    <div class="table-wrapper">
      <table id="scheduleTable">
        <thead>
          <tr>
            <th>Day</th>
            <th>Student</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- WEEKLY REVENUE -->
  <div class="card">
    <h2>Weekly Revenue</h2>
    <p id="weeklyExpected"></p>
    <p id="weeklyCollected"></p>
    <p id="weeklyOutstanding"></p>
    <canvas id="revenueChart"></canvas>
  </div>

</div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
  <h2>Admin Controls</h2>

  <div class="admin-section" id="studentEditor">
    <h3>Students</h3>
    <select id="studentSelect"></select>

    <input id="studentName" placeholder="Student Name" />
    <input id="studentGrade" placeholder="Grade" />
    <input id="studentRate" placeholder="Rate ($/hr)" />

    <button class="save-btn" onclick="saveStudent()">Save Student</button>
    <button class="delete-btn" onclick="deleteStudent()">Delete Student</button>

    <hr />
    <h3>Add New Student</h3>
    <input id="newStudentName" placeholder="Name" />
    <input id="newStudentGrade" placeholder="Grade" />
    <input id="newStudentRate" placeholder="Rate ($/hr)" />
    <button class="save-btn" onclick="addStudent()">Add Student</button>
  </div>

  <div class="admin-section" id="paymentsEditor">
    <h3>Payments</h3>
    <select id="paymentStudent"></select>

    <input id="paymentExpected" disabled />
    <input id="paymentPaid" placeholder="Paid Amount" />
    <input id="paymentPrepaid" placeholder="Prepaid Amount" />
    <select id="paymentStatus">
      <option value="paid">Paid</option>
      <option value="partial">Partial</option>
      <option value="notpaid">Not Paid</option>
    </select>

    <input id="paymentNotes" placeholder="Notes" />
    <button class="save-btn" onclick="savePayment()">Save Payment</button>
  </div>
</div>
<script>
// =====================
// DATA & LOCAL STORAGE
// =====================

const STORAGE_STUDENTS = "tutoring_students_v1";
const STORAGE_SCHEDULE = "tutoring_schedule_v1";
const STORAGE_PAYMENTS = "tutoring_payments_v1";

// Default students
let students = [
  { id: "diana",    name: "Diana",    grade: "4th",   rate: 40 },
  { id: "lucas",    name: "Lucas",    grade: "6th",   rate: 45 },
  { id: "eva",      name: "Eva",      grade: "4th",   rate: 27 }, // 40-min flat
  { id: "milana",   name: "Milana",   grade: "4th",   rate: 45 },
  { id: "leo",      name: "Leo",      grade: "1st",   rate: 30 },
  { id: "steph",    name: "Stephanie",grade: "4th",   rate: 35 },
  { id: "gabriel",  name: "Gabriel",  grade: "College",rate: 60 },
  { id: "maksim",   name: "Maksim",   grade: "7th",   rate: 65 },
  { id: "savion",   name: "Savion",   grade: "College",rate: 60 },
  { id: "eric",     name: "Eric",     grade: "College",rate: 75 },
  { id: "timothy",  name: "Timothy",  grade: "4th",   rate: 60 },
];

// Default weekly schedule (per session)
let schedule = [
  // Monday
  { id: "mon-diana",   day: "Monday",    studentId: "diana",   time: "6:30 â€“ 7:30 pm", durationHours: 1 },

  // Tuesday
  { id: "tue-eva",     day: "Tuesday",   studentId: "eva",     time: "4:20 â€“ 5:00 pm", durationHours: 40/60 },
  { id: "tue-lucas",   day: "Tuesday",   studentId: "lucas",   time: "5:00 â€“ 6:00 pm", durationHours: 1 },
  { id: "tue-timothy", day: "Tuesday",   studentId: "timothy", time: "7:00 â€“ 8:00 pm", durationHours: 1 },

  // Thursday
  { id: "thu-leo",     day: "Thursday",  studentId: "leo",     time: "3:00 â€“ 4:00 pm", durationHours: 1 },
  { id: "thu-lucas",   day: "Thursday",  studentId: "lucas",   time: "5:00 â€“ 6:00 pm", durationHours: 1 },
  { id: "thu-steph",   day: "Thursday",  studentId: "steph",   time: "6:00 â€“ 7:00 pm", durationHours: 1 },

  // Friday
  { id: "fri-savion",  day: "Friday",    studentId: "savion",  time: "(time TBD)",      durationHours: 1 },
  { id: "fri-gab",     day: "Friday",    studentId: "gabriel", time: "1:00 â€“ 2:00 pm (Calc)", durationHours: 1, rateOverride: 60 },
  { id: "fri-leo",     day: "Friday",    studentId: "leo",     time: "3:00 â€“ 4:00 pm",  durationHours: 1 },
  { id: "fri-diana",   day: "Friday",    studentId: "diana",   time: "4:00 â€“ 5:00 pm",  durationHours: 1 },
  { id: "fri-maksim",  day: "Friday",    studentId: "maksim",  time: "5:00 â€“ 6:00 pm",  durationHours: 1 },

  // Saturday
  { id: "sat-milana",  day: "Saturday",  studentId: "milana",  time: "11:00 â€“ 12:00 pm",durationHours: 1 },

  // Sunday
  { id: "sun-maksim",  day: "Sunday",    studentId: "maksim",  time: "10:00 â€“ 11:00 am",durationHours: 1 },
  { id: "sun-eric",    day: "Sunday",    studentId: "eric",    time: "11:00 â€“ 12:00 pm",durationHours: 1 },
  // Gabriel history @ 85/hr
  { id: "sun-gab-hist",day: "Sunday",    studentId: "gabriel", time: "12:00 â€“ 1:00 pm (History)", durationHours: 1, rateOverride: 85 },
];

// payments[weekKey][studentId] = { expected, paid, prepaid, status, notes }
let payments = {};

// ------------- Helpers for localStorage -------------

function loadData() {
  try {
    const s = localStorage.getItem(STORAGE_STUDENTS);
    const sch = localStorage.getItem(STORAGE_SCHEDULE);
    const pay = localStorage.getItem(STORAGE_PAYMENTS);
    if (s) students = JSON.parse(s);
    if (sch) schedule = JSON.parse(sch);
    if (pay) payments = JSON.parse(pay);
  } catch (e) {
    console.error("Error loading from localStorage, using defaults.", e);
  }
}

function saveData() {
  localStorage.setItem(STORAGE_STUDENTS, JSON.stringify(students));
  localStorage.setItem(STORAGE_SCHEDULE, JSON.stringify(schedule));
  localStorage.setItem(STORAGE_PAYMENTS, JSON.stringify(payments));
}

// ================ WEEK KEY (MONDAY START) =================

function getMondayStart(date) {
  const d = new Date(date);
  const day = d.getDay(); // 0 Sun, 1 Mon, ...
  const diff = (day === 0 ? -6 : 1) - day;
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}

function formatDateKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function getCurrentWeekKey() {
  return formatDateKey(getMondayStart(new Date()));
}

// ============ COMPUTE EXPECTED REVENUE ===================

function getStudentById(id) {
  return students.find(s => s.id === id);
}

function computeExpectedForStudent(studentId) {
  const st = getStudentById(studentId);
  if (!st) return 0;
  let total = 0;
  for (const sess of schedule) {
    if (sess.studentId !== studentId) continue;

    // Eva: flat $27 per 40-min session
    if (studentId === "eva") {
      total += 27;
    } else {
      const rate = (sess.rateOverride != null) ? sess.rateOverride : st.rate;
      const hours = sess.durationHours || 1;
      total += rate * hours;
    }
  }
  return total;
}

function computeWeeklyTotals() {
  const weekKey = getCurrentWeekKey();
  let expectedTotal = 0;
  let collectedTotal = 0;

  for (const st of students) {
    const exp = computeExpectedForStudent(st.id);
    expectedTotal += exp;

    const wk = payments[weekKey] || {};
    const rec = wk[st.id] || {};
    const paid = Number(rec.paid || 0);
    const prepaid = Number(rec.prepaid || 0);
    collectedTotal += (paid + prepaid);
  }

  return {
    expected: expectedTotal,
    collected: collectedTotal,
    outstanding: Math.max(0, expectedTotal - collectedTotal)
  };
}

// month/year totals (very simple: sum over all saved weeks)
function computeMonthYearTotals() {
  const now = new Date();
  const thisMonth = now.getMonth();
  const thisYear = now.getFullYear();

  let monthExpected = 0;
  let monthCollected = 0;
  let yearExpected = 0;
  let yearCollected = 0;

  for (const [weekKey, recs] of Object.entries(payments)) {
    const d = new Date(weekKey);
    if (isNaN(d)) continue;

    let weekExpected = 0;
    let weekCollected = 0;
    for (const [studentId, r] of Object.entries(recs)) {
      const exp = Number(r.expected || computeExpectedForStudent(studentId));
      const paid = Number(r.paid || 0);
      const prepaid = Number(r.prepaid || 0);
      weekExpected += exp;
      weekCollected += (paid + prepaid);
    }

    if (d.getFullYear() === thisYear) {
      yearExpected += weekExpected;
      yearCollected += weekCollected;
      if (d.getMonth() === thisMonth) {
        monthExpected += weekExpected;
        monthCollected += weekCollected;
      }
    }
  }

  return {
    monthExpected,
    monthCollected,
    monthOutstanding: Math.max(0, monthExpected - monthCollected),
    yearExpected,
    yearCollected,
    yearOutstanding: Math.max(0, yearExpected - yearCollected)
  };
}

// ================== RENDER TABLES ========================

function renderStudentsTable() {
  const tbody = document.querySelector("#studentsTable tbody");
  tbody.innerHTML = "";
  students.forEach(st => {
    const tr = document.createElement("tr");
    const tdName = document.createElement("td");
    const tdGrade = document.createElement("td");
    const tdRate = document.createElement("td");

    tdName.textContent = st.name;
    tdGrade.textContent = st.grade;
    tdRate.textContent = st.id === "eva" ? "$27 / 40 min" : `$${st.rate} / hr`;

    tr.appendChild(tdName);
    tr.appendChild(tdGrade);
    tr.appendChild(tdRate);
    tbody.appendChild(tr);
  });
}

function renderScheduleTable() {
  const tbody = document.querySelector("#scheduleTable tbody");
  tbody.innerHTML = "";

  // sort by day order
  const dayOrder = { Monday:1, Tuesday:2, Wednesday:3, Thursday:4, Friday:5, Saturday:6, Sunday:7 };
  const sorted = [...schedule].sort((a,b) => (dayOrder[a.day] || 10) - (dayOrder[b.day] || 10));

  sorted.forEach(sess => {
    const st = getStudentById(sess.studentId);
    const tr = document.createElement("tr");

    const tdDay = document.createElement("td");
    const tdStudent = document.createElement("td");
    const tdTime = document.createElement("td");

    tdDay.textContent = sess.day;
    tdStudent.textContent = st ? st.name : "(unknown)";
    tdTime.textContent = sess.time;

    tr.appendChild(tdDay);
    tr.appendChild(tdStudent);
    tr.appendChild(tdTime);
    tbody.appendChild(tr);
  });
}

// ================== REVENUE SUMMARY ======================

function renderRevenueSummary() {
  const weekTotals = computeWeeklyTotals();
  const monthYearTotals = computeMonthYearTotals();

  const weeklyExpectedEl = document.getElementById("weeklyExpected");
  const weeklyCollectedEl = document.getElementById("weeklyCollected");
  const weeklyOutstandingEl = document.getElementById("weeklyOutstanding");

  weeklyExpectedEl.textContent = `Expected this week: $${weekTotals.expected.toFixed(2)}`;
  weeklyCollectedEl.textContent =
    `Collected this week: $${weekTotals.collected.toFixed(2)} ` +
    `(Month collected: $${monthYearTotals.monthCollected.toFixed(2)}, ` +
    `Year collected: $${monthYearTotals.yearCollected.toFixed(2)})`;
  weeklyOutstandingEl.textContent =
    `Outstanding this week: $${weekTotals.outstanding.toFixed(2)} ` +
    `(Month outstanding: $${monthYearTotals.monthOutstanding.toFixed(2)}, ` +
    `Year outstanding: $${monthYearTotals.yearOutstanding.toFixed(2)})`;

  drawRevenueChart();
}

// ============== SIMPLE BAR CHART (NO LIBRARY) ============

function drawRevenueChart() {
  const canvas = document.getElementById("revenueChart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  // resize to actual CSS size
  const w = canvas.clientWidth || 300;
  const h = canvas.clientHeight || 200;
  canvas.width = w;
  canvas.height = h;

  ctx.clearRect(0, 0, w, h);

  // build expected per student
  const data = students.map(st => ({
    name: st.name,
    value: computeExpectedForStudent(st.id)
  })).filter(d => d.value > 0);

  if (data.length === 0) {
    ctx.fillStyle = "#888";
    ctx.font = "14px Arial";
    ctx.fillText("No data available yet.", 10, 30);
    return;
  }

  const maxVal = Math.max(...data.map(d => d.value), 50);
  const padding = 30;
  const barWidth = (w - padding * 2) / data.length;

  // axis
  ctx.strokeStyle = "#555";
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, h - padding);
  ctx.lineTo(w - padding, h - padding);
  ctx.stroke();

  // bars
  ctx.fillStyle = "#0077ff";
  data.forEach((d, i) => {
    const x = padding + i * barWidth + barWidth * 0.2;
    const barHeight = (d.value / maxVal) * (h - padding * 2 - 10);
    const y = (h - padding) - barHeight;
    ctx.fillRect(x, y, barWidth * 0.6, barHeight);

    // label
    ctx.fillStyle = "#ccc";
    ctx.font = "10px Arial";
    ctx.textAlign = "center";
    ctx.fillText(d.name, x + barWidth * 0.3, h - padding + 12);

    ctx.fillStyle = "#0077ff";
  });
}

// ===================== ADMIN PANEL =======================

function toggleAdminPanel() {
  const panel = document.getElementById("adminPanel");
  panel.classList.toggle("open");
}

// ------- Admin: populate selects -------

function populateStudentSelects() {
  const studentSelect = document.getElementById("studentSelect");
  const paymentStudent = document.getElementById("paymentStudent");

  studentSelect.innerHTML = "";
  paymentStudent.innerHTML = "";

  students.forEach(st => {
    const opt1 = document.createElement("option");
    opt1.value = st.id;
    opt1.textContent = st.name;
    studentSelect.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = st.id;
    opt2.textContent = st.name;
    paymentStudent.appendChild(opt2);
  });

  if (students.length > 0) {
    studentSelect.value = students[0].id;
    paymentStudent.value = students[0].id;
    loadStudentIntoForm(students[0].id);
    loadPaymentIntoForm(students[0].id);
  }
}

function loadStudentIntoForm(studentId) {
  const st = getStudentById(studentId);
  if (!st) return;
  document.getElementById("studentName").value = st.name;
  document.getElementById("studentGrade").value = st.grade;
  document.getElementById("studentRate").value = st.rate;
}

function loadPaymentIntoForm(studentId) {
  const weekKey = getCurrentWeekKey();
  const weekRecs = payments[weekKey] || {};
  const rec = weekRecs[studentId] || {};

  const expected = computeExpectedForStudent(studentId);

  document.getElementById("paymentExpected").value = `Expected: $${expected.toFixed(2)}`;
  document.getElementById("paymentPaid").value = rec.paid ?? "";
  document.getElementById("paymentPrepaid").value = rec.prepaid ?? "";
  document.getElementById("paymentStatus").value = rec.status || "notpaid";
  document.getElementById("paymentNotes").value = rec.notes || "";
}

// ------- Admin: student actions -------

function saveStudent() {
  const select = document.getElementById("studentSelect");
  const id = select.value;
  if (!id) return;

  const st = getStudentById(id);
  if (!st) return;

  st.name = document.getElementById("studentName").value || st.name;
  st.grade = document.getElementById("studentGrade").value || st.grade;
  st.rate = Number(document.getElementById("studentRate").value || st.rate);

  saveData();
  renderStudentsTable();
  renderRevenueSummary();
  populateStudentSelects(); // refresh names in dropdowns
}

function deleteStudent() {
  const select = document.getElementById("studentSelect");
  const id = select.value;
  if (!id) return;
  if (!confirm("Delete this student and any schedule/payment data for them?")) return;

  students = students.filter(s => s.id !== id);
  schedule = schedule.filter(s => s.studentId !== id);

  // Remove from all payment weeks
  for (const [weekKey, recs] of Object.entries(payments)) {
    if (recs[id]) delete recs[id];
  }

  saveData();
  renderStudentsTable();
  renderScheduleTable();
  renderRevenueSummary();
  populateStudentSelects();
}

function addStudent() {
  const name = document.getElementById("newStudentName").value.trim();
  const grade = document.getElementById("newStudentGrade").value.trim() || "Unknown";
  const rateVal = document.getElementById("newStudentRate").value.trim();

  if (!name) {
    alert("Please enter a name for the new student.");
    return;
  }

  const id = "s" + Date.now();
  const rate = Number(rateVal || 0);

  students.push({ id, name, grade, rate });

  document.getElementById("newStudentName").value = "";
  document.getElementById("newStudentGrade").value = "";
  document.getElementById("newStudentRate").value = "";

  saveData();
  renderStudentsTable();
  populateStudentSelects();
  renderRevenueSummary();
}

// ------- Admin: payment actions -------

function savePayment() {
  const studentId = document.getElementById("paymentStudent").value;
  if (!studentId) return;
  const weekKey = getCurrentWeekKey();

  const paidStr = document.getElementById("paymentPaid").value;
  const prepaidStr = document.getElementById("paymentPrepaid").value;
  const status = document.getElementById("paymentStatus").value;
  const notes = document.getElementById("paymentNotes").value;

  const paid = Number(paidStr || 0);
  const prepaid = Number(prepaidStr || 0);
  const expected = computeExpectedForStudent(studentId);

  if (!payments[weekKey]) payments[weekKey] = {};
  payments[weekKey][studentId] = {
    expected,
    paid,
    prepaid,
    status,
    notes
  };

  saveData();
  renderRevenueSummary();
  loadPaymentIntoForm(studentId);
}

// ==================== INIT ==============================

function attachEvents() {
  const studentSelect = document.getElementById("studentSelect");
  const paymentStudent = document.getElementById("paymentStudent");

  studentSelect.addEventListener("change", () => {
    loadStudentIntoForm(studentSelect.value);
  });

  paymentStudent.addEventListener("change", () => {
    loadPaymentIntoForm(paymentStudent.value);
  });

  // redraw chart on resize so it fits
  window.addEventListener("resize", () => {
    renderRevenueSummary();
  });
}

function init() {
  loadData();
  renderStudentsTable();
  renderScheduleTable();
  populateStudentSelects();
  renderRevenueSummary();
  attachEvents();
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>


